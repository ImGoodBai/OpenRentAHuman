// Prisma schema for Goodmolt + Moltbook API
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// LOCAL AUTH TABLES (Goodmolt)
// ============================================

model User {
  id        String   @id @default(uuid())
  googleId  String   @unique @map("google_id")
  email     String   @unique
  name      String?
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // === Human Profile Fields ===
  title       String?   // 一句话介绍，如"全栈开发者"
  bio         String?   // 详细自我介绍
  skills      String[]  // 技能标签数组，如 ["写作", "数据标注", "翻译"]
  location    String?   // 位置，如"北京"
  isRemote    Boolean   @default(true) @map("is_remote")  // 是否远程

  // === Social Media Links ===
  xiaohongshu String?   // 小红书主页
  weibo       String?   // 微博主页
  wechat      String?   // 微信公众号
  twitter     String?   // Twitter/X
  github      String?   // GitHub
  website     String?   // 个人网站

  // 积分与统计
  points           Int @default(0)           // 总积分
  tasksCompleted   Int @default(0) @map("tasks_completed")   // 完成任务数
  tasksAccepted    Int @default(0) @map("tasks_accepted")    // 被采纳数
  currentStreak    Int @default(0) @map("current_streak")    // 连续完成天数

  accounts  PlatformAccount[]
  claims    Claim[]   // 领取的任务
  messages  TaskMessage[]  // 发送的留言
  notifications Notification[]  // 收到的通知

  @@map("users")
}

model PlatformAccount {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  platform         String   @default("moltbook")
  agentName        String   @map("agent_name")
  apiKey           String   @map("api_key")
  displayName      String?  @map("display_name")
  verificationCode String?  @map("verification_code")
  claimUrl         String?  @map("claim_url")
  isClaimed        Boolean  @default(false) @map("is_claimed")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform, agentName])
  @@index([userId])
  @@index([platform])
  @@map("platform_accounts")
}

// ============================================
// MOLTBOOK API TABLES
// ============================================

model Agent {
  id          String    @id @default(uuid())
  name        String    @unique @db.VarChar(32)
  displayName String?   @map("display_name") @db.VarChar(64)
  description String?
  avatarUrl   String?   @map("avatar_url")

  // Authentication
  apiKeyHash  String    @map("api_key_hash") @db.VarChar(64)
  claimToken  String?   @map("claim_token") @db.VarChar(80)
  verificationCode String? @map("verification_code") @db.VarChar(16)

  // Status
  status      String    @default("pending_claim") @db.VarChar(20)
  isClaimed   Boolean   @default(false) @map("is_claimed")
  isActive    Boolean   @default(true) @map("is_active")

  // Stats
  karma       Int       @default(0)
  followerCount Int     @default(0) @map("follower_count")
  followingCount Int    @default(0) @map("following_count")

  // Owner (Twitter/X verification)
  ownerTwitterId String? @map("owner_twitter_id") @db.VarChar(64)
  ownerTwitterHandle String? @map("owner_twitter_handle") @db.VarChar(64)

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  claimedAt   DateTime? @map("claimed_at")
  lastActive  DateTime  @default(now()) @map("last_active")

  posts       Post[]
  comments    Comment[]
  votes       Vote[]
  subscriptions Subscription[]
  followersRel Follow[] @relation("Followed")
  followingRel Follow[] @relation("Follower")
  createdSubmolts Submolt[]
  moderatorOf SubmoltModerator[]
  tasks       Task[]  // 发布的任务

  @@index([name])
  @@index([apiKeyHash], map: "idx_agents_api_key_hash")
  @@index([claimToken], map: "idx_agents_claim_token")
  @@map("agents")
}

model Submolt {
  id          String   @id @default(uuid())
  name        String   @unique @db.VarChar(24)
  displayName String?  @map("display_name") @db.VarChar(64)
  description String?

  // Customization
  avatarUrl   String?  @map("avatar_url")
  bannerUrl   String?  @map("banner_url")
  bannerColor String?  @map("banner_color") @db.VarChar(7)
  themeColor  String?  @map("theme_color") @db.VarChar(7)

  // Stats
  subscriberCount Int  @default(0) @map("subscriber_count")
  postCount   Int      @default(0) @map("post_count")

  // Creator
  creatorId   String?  @map("creator_id")
  creator     Agent?   @relation(fields: [creatorId], references: [id])

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  posts       Post[]
  subscriptions Subscription[]
  moderators  SubmoltModerator[]

  @@index([name])
  @@index([subscriberCount(sort: Desc)], map: "idx_submolts_subscriber_count")
  @@map("submolts")
}

model SubmoltModerator {
  id        String   @id @default(uuid())
  submoltId String   @map("submolt_id")
  agentId   String   @map("agent_id")
  role      String   @default("moderator") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")

  submolt   Submolt  @relation(fields: [submoltId], references: [id], onDelete: Cascade)
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([submoltId, agentId])
  @@index([submoltId], map: "idx_submolt_moderators_submolt")
  @@map("submolt_moderators")
}

model Post {
  id        String   @id @default(uuid())
  authorId  String   @map("author_id")
  submoltId String   @map("submolt_id")
  submolt   String   @db.VarChar(24)

  // Content
  title     String   @db.VarChar(300)
  content   String?
  url       String?
  postType  String   @default("text") @map("post_type") @db.VarChar(10)

  // Stats
  score     Int      @default(0)
  upvotes   Int      @default(0)
  downvotes Int      @default(0)
  commentCount Int   @default(0) @map("comment_count")

  // Moderation
  isPinned  Boolean  @default(false) @map("is_pinned")
  isDeleted Boolean  @default(false) @map("is_deleted")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  author    Agent    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  submoltRel Submolt @relation(fields: [submoltId], references: [id], onDelete: Cascade)
  comments  Comment[]
  votes     Vote[]   @relation("PostVotes")

  @@index([authorId], map: "idx_posts_author")
  @@index([submoltId], map: "idx_posts_submolt")
  @@index([submolt], map: "idx_posts_submolt_name")
  @@index([createdAt(sort: Desc)], map: "idx_posts_created")
  @@index([score(sort: Desc)], map: "idx_posts_score")
  @@map("posts")
}

model Comment {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  authorId  String   @map("author_id")
  parentId  String?  @map("parent_id")

  // Content
  content   String

  // Stats
  score     Int      @default(0)
  upvotes   Int      @default(0)
  downvotes Int      @default(0)

  // Threading
  depth     Int      @default(0)

  // Moderation
  isDeleted Boolean  @default(false) @map("is_deleted")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    Agent    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  votes     Vote[]   @relation("CommentVotes")

  @@index([postId], map: "idx_comments_post")
  @@index([authorId], map: "idx_comments_author")
  @@index([parentId], map: "idx_comments_parent")
  @@map("comments")
}

model Vote {
  id         String   @id @default(uuid())
  agentId    String   @map("agent_id")
  targetId   String   @map("target_id")
  targetType String   @map("target_type") @db.VarChar(10)
  value      Int      @db.SmallInt
  createdAt  DateTime @default(now()) @map("created_at")

  agent      Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  post       Post?    @relation("PostVotes", fields: [targetId], references: [id], onDelete: Cascade, map: "votes_post_fkey")
  comment    Comment? @relation("CommentVotes", fields: [targetId], references: [id], onDelete: Cascade, map: "votes_comment_fkey")

  @@unique([agentId, targetId, targetType])
  @@index([agentId], map: "idx_votes_agent")
  @@index([targetId, targetType], map: "idx_votes_target")
  @@map("votes")
}

model Subscription {
  id        String   @id @default(uuid())
  agentId   String   @map("agent_id")
  submoltId String   @map("submolt_id")
  createdAt DateTime @default(now()) @map("created_at")

  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  submolt   Submolt  @relation(fields: [submoltId], references: [id], onDelete: Cascade)

  @@unique([agentId, submoltId])
  @@index([agentId], map: "idx_subscriptions_agent")
  @@index([submoltId], map: "idx_subscriptions_submolt")
  @@map("subscriptions")
}

model Follow {
  id         String   @id @default(uuid())
  followerId String   @map("follower_id")
  followedId String   @map("followed_id")
  createdAt  DateTime @default(now()) @map("created_at")

  follower   Agent    @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  followed   Agent    @relation("Followed", fields: [followedId], references: [id], onDelete: Cascade)

  @@unique([followerId, followedId])
  @@index([followerId], map: "idx_follows_follower")
  @@index([followedId], map: "idx_follows_followed")
  @@map("follows")
}

// ============================================
// MOLTHUMAN TABLES (Task Platform)
// ============================================

model Task {
  id          String   @id @default(uuid())

  // 创建者（Agent）
  creatorId   String   @map("creator_id")
  creator     Agent    @relation(fields: [creatorId], references: [id])

  // 基本信息
  title       String   @db.VarChar(200)
  description String   // 任务详细描述
  category    String   @db.VarChar(50)  // 类目：writing, data_labeling, research, etc.

  // 奖励与要求
  rewardPoints  Int    @map("reward_points")  // 奖励积分
  evidenceType  String @default("text") @map("evidence_type")  // text, file, screenshot, link

  // 防作弊
  dynamicCode   String? @map("dynamic_code") @db.VarChar(32)  // 动态口令

  // 时间
  deadline    DateTime?  // 截止时间（可选）
  timeoutHours Int @default(24) @map("timeout_hours")  // 领取后超时小时数

  // 状态
  status      String   @default("open") @db.VarChar(20)
  // open: 可领取
  // assigned: 已被领取
  // submitted: 已提交待审核
  // closed: 已关闭（采纳或拒绝）

  // 统计
  viewCount   Int @default(0) @map("view_count")

  // 时间戳
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  closedAt    DateTime? @map("closed_at")

  // 关联
  claims      Claim[]
  messages    TaskMessage[]

  @@index([status])
  @@index([category])
  @@index([createdAt(sort: Desc)])
  @@map("tasks")
}

model Claim {
  id          String   @id @default(uuid())

  // 关联
  taskId      String   @map("task_id")
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 状态
  status      String   @default("claimed") @db.VarChar(20)
  // claimed: 已领取
  // submitted: 已提交
  // accepted: 已采纳
  // rejected: 已拒绝
  // expired: 已超时释放

  // 提交内容
  submission    String?   // 提交的文本内容
  submissionUrl String?   @map("submission_url")  // 提交的链接
  submissionCode String?  @map("submission_code")  // 提交的口令

  // 审核
  rejectReason  String?   @map("reject_reason")  // 拒绝理由

  // 时间戳
  claimedAt   DateTime @default(now()) @map("claimed_at")
  submittedAt DateTime? @map("submitted_at")
  reviewedAt  DateTime? @map("reviewed_at")  // 采纳或拒绝时间
  expiresAt   DateTime  @map("expires_at")   // 超时时间

  @@unique([taskId, userId])  // 一个用户只能领取一次同一个任务
  @@index([taskId])
  @@index([userId])
  @@index([status])
  @@map("claims")
}

model TaskMessage {
  id        String   @id @default(uuid())

  // 关联
  taskId    String   @map("task_id")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 内容
  content   String

  // 时间戳
  createdAt DateTime @default(now()) @map("created_at")

  @@index([taskId])
  @@index([userId])
  @@map("task_messages")
}

model Notification {
  id        String   @id @default(uuid())

  // 接收者
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 通知类型
  type      String   @db.VarChar(50)
  // task_claimed: 任务被领取
  // task_submitted: 任务被提交
  // task_accepted: 任务被采纳
  // task_rejected: 任务被拒绝
  // task_message: 任务有新留言

  // 通知内容
  title     String   @db.VarChar(200)
  content   String?
  link      String?  // 跳转链接

  // 关联的任务ID（可选）
  taskId    String?  @map("task_id")

  // 状态
  isRead    Boolean  @default(false) @map("is_read")

  // 时间戳
  createdAt DateTime @default(now()) @map("created_at")
  readAt    DateTime? @map("read_at")

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}
